/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import RegularEvent from"@typo3/core/event/regular-event.js";import Icons from"@typo3/backend/icons.js";import PersistentStorage from"@typo3/backend/storage/persistent.js";import Viewport from"@typo3/backend/viewport.js";var SystemInformationSelector;!function(e){e.element="#typo3-cms-backend-backend-toolbaritems-systeminformationtoolbaritem",e.icon="#typo3-cms-backend-backend-toolbaritems-systeminformationtoolbaritem .toolbar-item-icon .t3js-icon",e.menu="#typo3-cms-backend-backend-toolbaritems-systeminformationtoolbaritem .dropdown-menu",e.data="[data-systeminformation-data]",e.badge="[data-systeminformation-badge]",e.message="[data-systeminformation-message-module]",e.messageLink="[data-systeminformation-message-module] a"}(SystemInformationSelector||(SystemInformationSelector={}));class SystemInformationMenu{constructor(){this.timer=null,this.updateMenu=()=>{const e=document.querySelector(SystemInformationSelector.icon),t=e.cloneNode(!0);null!==this.timer&&(clearTimeout(this.timer),this.timer=null),Icons.getIcon("spinner-circle",Icons.sizes.small).then((t=>{e.replaceWith(document.createRange().createContextualFragment(t))})),new AjaxRequest(TYPO3.settings.ajaxUrls.systeminformation_render).get().then((async e=>{document.querySelector(SystemInformationSelector.menu).innerHTML=await e.resolve(),SystemInformationMenu.updateBadge()})).finally((()=>{document.querySelector(SystemInformationSelector.icon).replaceWith(t),this.timer=setTimeout(this.updateMenu,3e5)}))},new RegularEvent("click",this.handleMessageLinkClick).delegateTo(document,SystemInformationSelector.messageLink),Viewport.Topbar.Toolbar.registerEvent(this.updateMenu)}static getData(){const e=document.querySelector(SystemInformationSelector.data),t=e?.dataset;return{count:t?.systeminformationDataCount?parseInt(t.systeminformationDataCount,10):0,severityBadgeClass:t?.systeminformationDataSeveritybadgeclass??""}}static getMessageDataFromElement(e){const t=e.dataset;return{count:t.systeminformationMessageCount?parseInt(t.systeminformationMessageCount,10):0,status:t.systeminformationMessageStatus??"",module:t.systeminformationMessageModule??"",params:t.systeminformationMessageParams??""}}static updateBadge(){const e=SystemInformationMenu.getData(),t=document.querySelector(SystemInformationSelector.badge);t.removeAttribute("class"),t.classList.add("toolbar-item-badge"),t.classList.add("badge"),""!==e.severityBadgeClass&&t.classList.add(e.severityBadgeClass),t.textContent=e.count.toString(),t.classList.toggle("hidden",!(e.count>0))}handleMessageLinkClick(e,t){const o=SystemInformationMenu.getMessageDataFromElement(t.closest(SystemInformationSelector.message));if(""===o.module)return;e.preventDefault(),e.stopPropagation();const s={},a=Math.floor(Date.now()/1e3);let n={};PersistentStorage.isset("systeminformation")&&(n=JSON.parse(PersistentStorage.get("systeminformation"))),s[o.module]={lastAccess:a},Object.assign(n,s);PersistentStorage.set("systeminformation",JSON.stringify(n)).then((()=>{TYPO3.ModuleMenu.App.showModule(o.module,o.params),Viewport.Topbar.refresh()}))}}export default new SystemInformationMenu;