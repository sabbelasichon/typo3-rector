import{Plugin as e}from"@ckeditor/ckeditor5-core";import{EventInfo as t,toUnit as r,delay as i,DomEmitterMixin as o,global as n,Rect as a,ResizeObserver as s,env as d,uid as l,createElement as c}from"@ckeditor/ckeditor5-utils";import{DomEventObserver as g,DataTransfer as p,MouseObserver as h,LiveRange as u}from"@ckeditor/ckeditor5-engine";import{Widget as m,isWidget as f}from"@ckeditor/ckeditor5-widget";import{View as b}from"@ckeditor/ckeditor5-ui";import{throttle as k}from"lodash-es";
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class _ extends g{constructor(e){super(e),this.domEventType=["paste","copy","cut","drop","dragover","dragstart","dragend","dragenter","dragleave"];const r=this.document;function i(e){return(i,o)=>{o.preventDefault();const n=o.dropRange?[o.dropRange]:null,a=new t(r,e);r.fire(a,{dataTransfer:o.dataTransfer,method:i.name,targetRanges:n,target:o.target,domEvent:o.domEvent}),a.stop.called&&o.stopPropagation()}}this.listenTo(r,"paste",i("clipboardInput"),{priority:"low"}),this.listenTo(r,"drop",i("clipboardInput"),{priority:"low"}),this.listenTo(r,"dragover",i("dragging"),{priority:"low"})}onDomEvent(e){const t="clipboardData"in e?e.clipboardData:e.dataTransfer,r="drop"==e.type||"paste"==e.type,i={dataTransfer:new p(t,{cacheFiles:r})};"drop"!=e.type&&"dragover"!=e.type||(i.dropRange=function(e,t){const r=t.target.ownerDocument,i=t.clientX,o=t.clientY;let n;r.caretRangeFromPoint&&r.caretRangeFromPoint(i,o)?n=r.caretRangeFromPoint(i,o):t.rangeParent&&(n=r.createRange(),n.setStart(t.rangeParent,t.rangeOffset),n.collapse(!0));if(n)return e.domConverter.domRangeToView(n);return null}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */(this.view,e)),this.fire(e.type,e,i)}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
const v=["figcaption","li"],w=["ol","ul"];function T(e){if(e.is("$text")||e.is("$textProxy"))return e.data;if(e.is("element","img")&&e.hasAttribute("alt"))return e.getAttribute("alt");if(e.is("element","br"))return"\n";let t="",r=null;for(const i of e.getChildren())t+=D(i,r)+T(i),r=i;return t}function D(e,t){return t?e.is("element","li")&&!e.isEmpty&&e.getChild(0).is("containerElement")||w.includes(e.name)&&w.includes(t.name)?"\n\n":e.is("containerElement")||t.is("containerElement")?v.includes(e.name)||v.includes(t.name)?"\n":"\n\n":"":""}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class y extends e{static get pluginName(){return"ClipboardPipeline"}init(){this.editor.editing.view.addObserver(_),this._setupPasteDrop(),this._setupCopyCut()}_fireOutputTransformationEvent(e,t,r){const i=this.editor.model.getSelectedContent(t);this.fire("outputTransformation",{dataTransfer:e,content:i,method:r})}_setupPasteDrop(){const e=this.editor,r=e.model,i=e.editing.view,o=i.document;this.listenTo(o,"clipboardInput",((t,r)=>{"paste"!=r.method||e.model.canEditAt(e.model.document.selection)||t.stop()}),{priority:"highest"}),this.listenTo(o,"clipboardInput",((e,r)=>{const o=r.dataTransfer;let n;if(r.content)n=r.content;else{let e="";o.getData("text/html")?e=
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
function(e){return e.replace(/<span(?: class="Apple-converted-space"|)>(\s+)<\/span>/g,((e,t)=>1==t.length?" ":t)).replace(/<!--[\s\S]*?-->/g,"")}(o.getData("text/html")):o.getData("text/plain")&&(((a=(a=o.getData("text/plain")).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r?\n\r?\n/g,"</p><p>").replace(/\r?\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/^\s/,"&nbsp;").replace(/\s$/,"&nbsp;").replace(/\s\s/g," &nbsp;")).includes("</p><p>")||a.includes("<br>"))&&(a=`<p>${a}</p>`),e=a),n=this.editor.data.htmlProcessor.toView(e)}var a;const s=new t(this,"inputTransformation");this.fire(s,{content:n,dataTransfer:o,targetRanges:r.targetRanges,method:r.method}),s.stop.called&&e.stop(),i.scrollToTheSelection()}),{priority:"low"}),this.listenTo(this,"inputTransformation",((e,t)=>{if(t.content.isEmpty)return;const i=this.editor.data.toModel(t.content,"$clipboardHolder");0!=i.childCount&&(e.stop(),r.change((()=>{this.fire("contentInsertion",{content:i,method:t.method,dataTransfer:t.dataTransfer,targetRanges:t.targetRanges})})))}),{priority:"low"}),this.listenTo(this,"contentInsertion",((e,t)=>{t.resultRange=r.insertContent(t.content)}),{priority:"low"})}_setupCopyCut(){const e=this.editor,t=e.model.document,r=e.editing.view.document,i=(e,r)=>{const i=r.dataTransfer;r.preventDefault(),this._fireOutputTransformationEvent(i,t.selection,e.name)};this.listenTo(r,"copy",i,{priority:"low"}),this.listenTo(r,"cut",((t,r)=>{e.model.canEditAt(e.model.document.selection)?i(t,r):r.preventDefault()}),{priority:"low"}),this.listenTo(this,"outputTransformation",((t,i)=>{const o=e.data.toView(i.content);r.fire("clipboardOutput",{dataTransfer:i.dataTransfer,content:o,method:i.method})}),{priority:"low"}),this.listenTo(r,"clipboardOutput",((r,i)=>{i.content.isEmpty||(i.dataTransfer.setData("text/html",this.editor.data.htmlProcessor.toData(i.content)),i.dataTransfer.setData("text/plain",T(i.content))),"cut"==i.method&&e.model.deleteContent(t.selection)}),{priority:"low"})}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */const E=r("px");class R extends b{constructor(){super();const e=this.bindTemplate;this.set({isVisible:!1,left:null,top:null,width:null}),this.setTemplate({tag:"div",attributes:{class:["ck","ck-clipboard-drop-target-line",e.if("isVisible","ck-hidden",(e=>!e))],style:{left:e.to("left",(e=>E(e))),top:e.to("top",(e=>E(e))),width:e.to("width",(e=>E(e)))}}})}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class C extends e{constructor(){super(...arguments),this.removeDropMarkerDelayed=i((()=>this.removeDropMarker()),40),this._updateDropMarkerThrottled=k((e=>this._updateDropMarker(e)),40),this._reconvertMarkerThrottled=k((()=>{this.editor.model.markers.has("drop-target")&&this.editor.editing.reconvertMarker("drop-target")}),0),this._dropTargetLineView=new R,this._domEmitter=new(o()),this._scrollables=new Map}static get pluginName(){return"DragDropTarget"}init(){this._setupDropMarker()}destroy(){this._domEmitter.stopListening();for(const{resizeObserver:e}of this._scrollables.values())e.destroy();return this._updateDropMarkerThrottled.cancel(),this.removeDropMarkerDelayed.cancel(),this._reconvertMarkerThrottled.cancel(),super.destroy()}updateDropMarker(e,t,r,i,o,n){this.removeDropMarkerDelayed.cancel();const a=M(this.editor,e,t,r,i,o,n);
/* istanbul ignore next -- @preserve */if(a)return n&&n.containsRange(a)?this.removeDropMarker():void this._updateDropMarkerThrottled(a)}getFinalDropRange(e,t,r,i,o,n){const a=M(this.editor,e,t,r,i,o,n);return this.removeDropMarker(),a}removeDropMarker(){const e=this.editor.model;this.removeDropMarkerDelayed.cancel(),this._updateDropMarkerThrottled.cancel(),this._dropTargetLineView.isVisible=!1,e.markers.has("drop-target")&&e.change((e=>{e.removeMarker("drop-target")}))}_setupDropMarker(){const e=this.editor;e.ui.view.body.add(this._dropTargetLineView),e.conversion.for("editingDowncast").markerToHighlight({model:"drop-target",view:{classes:["ck-clipboard-drop-target-range"]}}),e.conversion.for("editingDowncast").markerToElement({model:"drop-target",view:(t,{writer:r})=>{if(e.model.schema.checkChild(t.markerRange.start,"$text"))return this._dropTargetLineView.isVisible=!1,this._createDropTargetPosition(r);t.markerRange.isCollapsed?this._updateDropTargetLine(t.markerRange):this._dropTargetLineView.isVisible=!1}})}_updateDropMarker(e){const t=this.editor,r=t.model.markers;t.model.change((t=>{r.has("drop-target")?r.get("drop-target").getRange().isEqual(e)||t.updateMarker("drop-target",{range:e}):t.addMarker("drop-target",{range:e,usingOperation:!1,affectsData:!1})}))}_createDropTargetPosition(e){return e.createUIElement("span",{class:"ck ck-clipboard-drop-target-position"},(function(e){const t=this.toDomElement(e);return t.append("⁠",e.createElement("span"),"⁠"),t}))}_updateDropTargetLine(e){const t=this.editor.editing,r=e.start.nodeBefore,i=e.start.nodeAfter,o=e.start.parent,s=r?t.mapper.toViewElement(r):null,d=s?t.view.domConverter.mapViewToDom(s):null,l=i?t.mapper.toViewElement(i):null,c=l?t.view.domConverter.mapViewToDom(l):null,g=t.mapper.toViewElement(o),p=t.view.domConverter.mapViewToDom(g),h=this._getScrollableRect(g),{scrollX:u,scrollY:m}=n.window,f=d?new a(d):null,b=c?new a(c):null,k=new a(p).excludeScrollbarsAndBorders(),_=f?f.bottom:k.top,v=b?b.top:k.bottom,w=n.window.getComputedStyle(p),T=_<=v?(_+v)/2:v;if(h.top<T&&T<h.bottom){const e=k.left+parseFloat(w.paddingLeft),t=k.right-parseFloat(w.paddingRight),r=Math.max(e+u,h.left),i=Math.min(t+u,h.right);this._dropTargetLineView.set({isVisible:!0,left:r,top:T+m,width:i-r})}else this._dropTargetLineView.isVisible=!1}_getScrollableRect(e){const t=e.root.rootName;let r;if(this._scrollables.has(t))r=this._scrollables.get(t).domElement;else{r=function(e){let t=e;do{t=t.parentElement;const e=n.window.getComputedStyle(t).overflowY;if("auto"==e||"scroll"==e)break}while("BODY"!=t.tagName);return t}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */(this.editor.editing.view.domConverter.mapViewToDom(e)),this._domEmitter.listenTo(r,"scroll",this._reconvertMarkerThrottled,{usePassive:!0});const i=new s(r,this._reconvertMarkerThrottled);this._scrollables.set(t,{domElement:r,resizeObserver:i})}return new a(r).excludeScrollbarsAndBorders()}}function M(e,t,r,i,o,n,a){const s=e.model,d=e.editing.mapper;let l=V(e,t);for(;l;){if(!n)if(s.schema.checkChild(l,"$text")){if(r){const t=r[0].start,n=d.toModelPosition(t);if(!a||Array.from(a.getItems()).every((e=>s.schema.checkChild(n,e)))){if(s.schema.checkChild(n,"$text"))return s.createRange(n);if(t)return x(e,V(e,t.parent),i,o)}}}else if(s.schema.isInline(l))return x(e,l,i,o);if(s.schema.isBlock(l))return x(e,l,i,o);if(s.schema.checkChild(l,"$block")){const t=Array.from(l.getChildren()).filter((t=>t.is("element")&&!A(e,t)));let r=0,n=t.length;if(0==n)return s.createRange(s.createPositionAt(l,"end"));for(;r<n-1;){const a=Math.floor((r+n)/2);"before"==P(e,t[a],i,o)?n=a:r=a}return x(e,t[r],i,o)}l=l.parent}return null}function A(e,t){const r=e.editing.mapper,i=e.editing.view.domConverter,o=r.toViewElement(t),a=i.mapViewToDom(o);return"none"!=n.window.getComputedStyle(a).float}function x(e,t,r,i){const o=e.model;return o.createRange(o.createPositionAt(t,P(e,t,r,i)))}function P(e,t,r,i){const o=e.editing.mapper,n=e.editing.view.domConverter,s=o.toViewElement(t),d=n.mapViewToDom(s),l=new a(d);return e.model.schema.isInline(t)?r<(l.left+l.right)/2?"before":"after":i<(l.top+l.bottom)/2?"before":"after"}function V(e,t){const r=e.editing.mapper,i=e.editing.view,o=r.toModelElement(t);if(o)return o;const n=i.createPositionBefore(t),a=r.findMappedViewAncestor(n);return r.toModelElement(a)}class B extends e{constructor(){super(...arguments),this._isBlockDragging=!1,this._domEmitter=new(o())}static get pluginName(){return"DragDropBlockToolbar"}init(){const e=this.editor;if(this.listenTo(e,"change:isReadOnly",((e,t,r)=>{r?(this.forceDisabled("readOnlyMode"),this._isBlockDragging=!1):this.clearForceDisabled("readOnlyMode")})),d.isAndroid&&this.forceDisabled("noAndroidSupport"),e.plugins.has("BlockToolbar")){const t=e.plugins.get("BlockToolbar").buttonView.element;this._domEmitter.listenTo(t,"dragstart",((e,t)=>this._handleBlockDragStart(t))),this._domEmitter.listenTo(n.document,"dragover",((e,t)=>this._handleBlockDragging(t))),this._domEmitter.listenTo(n.document,"drop",((e,t)=>this._handleBlockDragging(t))),this._domEmitter.listenTo(n.document,"dragend",(()=>this._handleBlockDragEnd()),{useCapture:!0}),this.isEnabled&&t.setAttribute("draggable","true"),this.on("change:isEnabled",((e,r,i)=>{t.setAttribute("draggable",i?"true":"false")}))}}destroy(){return this._domEmitter.stopListening(),super.destroy()}_handleBlockDragStart(e){if(!this.isEnabled)return;const t=this.editor.model,r=t.document.selection,i=this.editor.editing.view,o=Array.from(r.getSelectedBlocks()),n=t.createRange(t.createPositionBefore(o[0]),t.createPositionAfter(o[o.length-1]));t.change((e=>e.setSelection(n))),this._isBlockDragging=!0,i.focus(),i.getObserver(_).onDomEvent(e)}_handleBlockDragging(e){if(!this.isEnabled||!this._isBlockDragging)return;const t=e.clientX+("ltr"==this.editor.locale.contentLanguageDirection?100:-100),r=e.clientY,i=document.elementFromPoint(t,r),o=this.editor.editing.view;i&&i.closest(".ck-editor__editable")&&o.getObserver(_).onDomEvent({...e,type:e.type,dataTransfer:e.dataTransfer,target:i,clientX:t,clientY:r,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()})}_handleBlockDragEnd(){this._isBlockDragging=!1}}!function(e,{insertAt:t}={}){if(!e||"undefined"==typeof document)return;const r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css",window.litNonce&&i.setAttribute("nonce",window.litNonce),"top"===t&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}('.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position{display:inline;pointer-events:none;position:relative}.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position span{position:absolute;width:0}.ck.ck-editor__editable .ck-widget:-webkit-drag>.ck-widget__selection-handle,.ck.ck-editor__editable .ck-widget:-webkit-drag>.ck-widget__type-around{display:none}.ck.ck-clipboard-drop-target-line{pointer-events:none;position:absolute}:root{--ck-clipboard-drop-target-dot-width:12px;--ck-clipboard-drop-target-dot-height:8px;--ck-clipboard-drop-target-color:var(--ck-color-focus-border)}.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position span{background:var(--ck-clipboard-drop-target-color);border:1px solid var(--ck-clipboard-drop-target-color);bottom:calc(var(--ck-clipboard-drop-target-dot-height)*-.5);margin-left:-1px;top:calc(var(--ck-clipboard-drop-target-dot-height)*-.5)}.ck.ck-editor__editable .ck.ck-clipboard-drop-target-position span:after{border-color:var(--ck-clipboard-drop-target-color) transparent transparent transparent;border-style:solid;border-width:calc(var(--ck-clipboard-drop-target-dot-height)) calc(var(--ck-clipboard-drop-target-dot-width)*.5) 0 calc(var(--ck-clipboard-drop-target-dot-width)*.5);content:"";display:block;height:0;left:50%;position:absolute;top:calc(var(--ck-clipboard-drop-target-dot-height)*-.5);transform:translateX(-50%);width:0}.ck.ck-editor__editable .ck-widget.ck-clipboard-drop-target-range{outline:var(--ck-widget-outline-thickness) solid var(--ck-clipboard-drop-target-color)!important}.ck.ck-editor__editable .ck-widget:-webkit-drag{zoom:.6;outline:none!important}.ck.ck-clipboard-drop-target-line{background:var(--ck-clipboard-drop-target-color);border:1px solid var(--ck-clipboard-drop-target-color);height:0;margin-top:-1px}.ck.ck-clipboard-drop-target-line:before{border-style:solid;content:"";height:0;position:absolute;top:calc(var(--ck-clipboard-drop-target-dot-width)*-.5);width:0}[dir=ltr] .ck.ck-clipboard-drop-target-line:before{border-color:transparent transparent transparent var(--ck-clipboard-drop-target-color);border-width:calc(var(--ck-clipboard-drop-target-dot-width)*.5) 0 calc(var(--ck-clipboard-drop-target-dot-width)*.5) var(--ck-clipboard-drop-target-dot-height);left:-1px}[dir=rtl] .ck.ck-clipboard-drop-target-line:before{border-color:transparent var(--ck-clipboard-drop-target-color) transparent transparent;border-width:calc(var(--ck-clipboard-drop-target-dot-width)*.5) var(--ck-clipboard-drop-target-dot-height) calc(var(--ck-clipboard-drop-target-dot-width)*.5) 0;right:-1px}');
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
class O extends e{constructor(){super(...arguments),this._clearDraggableAttributesDelayed=i((()=>this._clearDraggableAttributes()),40),this._blockMode=!1,this._domEmitter=new(o())}static get pluginName(){return"DragDrop"}static get requires(){return[y,m,C,B]}init(){const e=this.editor,t=e.editing.view;this._draggedRange=null,this._draggingUid="",this._draggableElement=null,t.addObserver(_),t.addObserver(h),this._setupDragging(),this._setupContentInsertionIntegration(),this._setupClipboardInputIntegration(),this._setupDraggableAttributeHandling(),this.listenTo(e,"change:isReadOnly",((e,t,r)=>{r?this.forceDisabled("readOnlyMode"):this.clearForceDisabled("readOnlyMode")})),this.on("change:isEnabled",((e,t,r)=>{r||this._finalizeDragging(!1)})),d.isAndroid&&this.forceDisabled("noAndroidSupport")}destroy(){return this._draggedRange&&(this._draggedRange.detach(),this._draggedRange=null),this._previewContainer&&this._previewContainer.remove(),this._domEmitter.stopListening(),this._clearDraggableAttributesDelayed.cancel(),super.destroy()}_setupDragging(){const e=this.editor,t=e.model,r=e.editing.view,i=r.document,o=e.plugins.get(C);this.listenTo(i,"dragstart",((e,r)=>{if(r.target&&r.target.is("editableElement"))return void r.preventDefault();if(this._prepareDraggedRange(r.target),!this._draggedRange)return void r.preventDefault();this._draggingUid=l(),r.dataTransfer.effectAllowed=this.isEnabled?"copyMove":"copy",r.dataTransfer.setData("application/ckeditor5-dragging-uid",this._draggingUid);const i=t.createSelection(this._draggedRange.toRange());this.editor.plugins.get("ClipboardPipeline")._fireOutputTransformationEvent(r.dataTransfer,i,"dragstart");const{dataTransfer:o,domTarget:n,domEvent:a}=r,{clientX:s}=a;this._updatePreview({dataTransfer:o,domTarget:n,clientX:s}),r.stopPropagation(),this.isEnabled||(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="")}),{priority:"low"}),this.listenTo(i,"dragend",((e,t)=>{this._finalizeDragging(!t.dataTransfer.isCanceled&&"move"==t.dataTransfer.dropEffect)}),{priority:"low"}),this._domEmitter.listenTo(n.document,"dragend",(()=>{this._blockMode=!1}),{useCapture:!0}),this.listenTo(i,"dragenter",(()=>{this.isEnabled&&r.focus()})),this.listenTo(i,"dragleave",(()=>{o.removeDropMarkerDelayed()})),this.listenTo(i,"dragging",((e,t)=>{if(!this.isEnabled)return void(t.dataTransfer.dropEffect="none");const{clientX:r,clientY:i}=t.domEvent;o.updateDropMarker(t.target,t.targetRanges,r,i,this._blockMode,this._draggedRange),this._draggedRange||(t.dataTransfer.dropEffect="copy"),d.isGecko||("copy"==t.dataTransfer.effectAllowed?t.dataTransfer.dropEffect="copy":["all","copyMove"].includes(t.dataTransfer.effectAllowed)&&(t.dataTransfer.dropEffect="move")),e.stop()}),{priority:"low"})}_setupClipboardInputIntegration(){const e=this.editor,t=e.editing.view.document,r=e.plugins.get(C);this.listenTo(t,"clipboardInput",((t,i)=>{if("drop"!=i.method)return;const{clientX:o,clientY:n}=i.domEvent,a=r.getFinalDropRange(i.target,i.targetRanges,o,n,this._blockMode,this._draggedRange);if(!a)return this._finalizeDragging(!1),void t.stop();this._draggedRange&&this._draggingUid!=i.dataTransfer.getData("application/ckeditor5-dragging-uid")&&(this._draggedRange.detach(),this._draggedRange=null,this._draggingUid="");if("move"==S(i.dataTransfer)&&this._draggedRange&&this._draggedRange.containsRange(a,!0))return this._finalizeDragging(!1),void t.stop();i.targetRanges=[e.editing.mapper.toViewRange(a)]}),{priority:"high"})}_setupContentInsertionIntegration(){const e=this.editor.plugins.get(y);e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const r=t.targetRanges.map((e=>this.editor.editing.mapper.toModelRange(e)));this.editor.model.change((e=>e.setSelection(r)))}),{priority:"high"}),e.on("contentInsertion",((e,t)=>{if(!this.isEnabled||"drop"!==t.method)return;const r="move"==S(t.dataTransfer),i=!t.resultRange||!t.resultRange.isCollapsed;this._finalizeDragging(i&&r)}),{priority:"lowest"})}_setupDraggableAttributeHandling(){const e=this.editor,t=e.editing.view,r=t.document;this.listenTo(r,"mousedown",((i,o)=>{if(d.isAndroid||!o)return;this._clearDraggableAttributesDelayed.cancel();let n=I(o.target);if(d.isBlink&&!e.isReadOnly&&!n&&!r.selection.isCollapsed){const e=r.selection.getSelectedElement();e&&f(e)||(n=r.selection.editableElement)}n&&(t.change((e=>{e.setAttribute("draggable","true",n)})),this._draggableElement=e.editing.mapper.toModelElement(n))})),this.listenTo(r,"mouseup",(()=>{d.isAndroid||this._clearDraggableAttributesDelayed()}))}_clearDraggableAttributes(){const e=this.editor.editing;e.view.change((t=>{this._draggableElement&&"$graveyard"!=this._draggableElement.root.rootName&&t.removeAttribute("draggable",e.mapper.toViewElement(this._draggableElement)),this._draggableElement=null}))}_finalizeDragging(e){const t=this.editor,r=t.model;if(t.plugins.get(C).removeDropMarker(),this._clearDraggableAttributes(),t.plugins.has("WidgetToolbarRepository")){t.plugins.get("WidgetToolbarRepository").clearForceDisabled("dragDrop")}this._draggingUid="",this._previewContainer&&(this._previewContainer.remove(),this._previewContainer=void 0),this._draggedRange&&(e&&this.isEnabled&&r.change((e=>{const t=r.createSelection(this._draggedRange);r.deleteContent(t,{doNotAutoparagraph:!0});const i=t.getFirstPosition().parent;i.isEmpty&&!r.schema.checkChild(i,"$text")&&r.schema.checkChild(i,"paragraph")&&e.insertElement("paragraph",i,0)})),this._draggedRange.detach(),this._draggedRange=null)}_prepareDraggedRange(e){const t=this.editor,r=t.model,i=r.document.selection,o=e?I(e):null;if(o){const e=t.editing.mapper.toModelElement(o);if(this._draggedRange=u.fromRange(r.createRangeOn(e)),this._blockMode=r.schema.isBlock(e),t.plugins.has("WidgetToolbarRepository")){t.plugins.get("WidgetToolbarRepository").forceDisabled("dragDrop")}return}if(i.isCollapsed&&!i.getFirstPosition().parent.isEmpty)return;const n=Array.from(i.getSelectedBlocks()),a=i.getFirstRange();if(0==n.length)return void(this._draggedRange=u.fromRange(a));const s=L(r,n);if(n.length>1)this._draggedRange=u.fromRange(s),this._blockMode=!0;else if(1==n.length){const e=a.start.isTouching(s.start)&&a.end.isTouching(s.end);this._draggedRange=u.fromRange(e?s:a),this._blockMode=e}r.change((e=>e.setSelection(this._draggedRange.toRange())))}_updatePreview({dataTransfer:e,domTarget:t,clientX:r}){const i=this.editor.editing.view,o=i.document.selection.editableElement,s=i.domConverter.mapViewToDom(o),l=n.window.getComputedStyle(s);this._previewContainer?this._previewContainer.firstElementChild&&this._previewContainer.removeChild(this._previewContainer.firstElementChild):(this._previewContainer=c(n.document,"div",{style:"position: fixed; left: -999999px;"}),n.document.body.appendChild(this._previewContainer));const g=new a(s);if(s.contains(t))return;const p=parseFloat(l.paddingLeft),h=c(n.document,"div");h.className="ck ck-content",h.style.width=l.width,h.style.paddingLeft=`${g.left-r+p}px`,d.isiOS&&(h.style.backgroundColor="white"),h.innerHTML=e.getData("text/html"),e.setDragImage(h,0,0),this._previewContainer.appendChild(h)}}function S(e){return d.isGecko?e.dropEffect:["all","copyMove"].includes(e.effectAllowed)?"move":"copy"}function I(e){if(e.is("editableElement"))return null;if(e.hasClass("ck-widget__selection-handle"))return e.findAncestor(f);if(f(e))return e;const t=e.findAncestor((e=>f(e)||e.is("editableElement")));return f(t)?t:null}function L(e,t){const r=t[0],i=t[t.length-1],o=r.getCommonAncestor(i),n=e.createPositionBefore(r),a=e.createPositionAfter(i);if(o&&o.is("element")&&!e.schema.isLimit(o)){const t=e.createRangeOn(o),r=n.isTouching(t.start),i=a.isTouching(t.end);if(r&&i)return L(e,[o])}return e.createRange(n,a)}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class F extends e{static get pluginName(){return"PastePlainText"}static get requires(){return[y]}init(){const e=this.editor,t=e.model,r=e.editing.view,i=r.document,o=t.document.selection;let n=!1;r.addObserver(_),this.listenTo(i,"keydown",((e,t)=>{n=t.shiftKey})),e.plugins.get(y).on("contentInsertion",((e,r)=>{(n||function(e,t){if(e.childCount>1)return!1;const r=e.getChild(0);if(t.isObject(r))return!1;return 0==Array.from(r.getAttributeKeys()).length}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */(r.content,t.schema))&&t.change((e=>{const i=Array.from(o.getAttributes()).filter((([e])=>t.schema.getAttributeProperties(e).isFormatting));o.isCollapsed||t.deleteContent(o,{doNotAutoparagraph:!0}),i.push(...o.getAttributes());const n=e.createRangeIn(r.content);for(const t of n.getItems())t.is("$textProxy")&&e.setAttributes(i,t)}))}))}}class N extends e{static get pluginName(){return"Clipboard"}static get requires(){return[y,O,F]}}export{N as Clipboard,y as ClipboardPipeline,O as DragDrop,B as DragDropBlockToolbar,C as DragDropTarget,F as PastePlainText};