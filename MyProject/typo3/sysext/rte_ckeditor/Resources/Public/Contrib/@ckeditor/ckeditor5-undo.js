import{Command as t,Plugin as e}from"@ckeditor/ckeditor5-core";import{transformSets as s,NoOperation as o}from"@ckeditor/ckeditor5-engine";import{ButtonView as i}from"@ckeditor/ckeditor5-ui";
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class a extends t{constructor(t){super(t),this._stack=[],this._createdBatches=new WeakSet,this.refresh(),this._isEnabledBasedOnSelection=!1,this.listenTo(t.data,"set",((t,e)=>{e[1]={...e[1]};const s=e[1];s.batchType||(s.batchType={isUndoable:!1})}),{priority:"high"}),this.listenTo(t.data,"set",((t,e)=>{e[1].batchType.isUndoable||this.clearStack()}))}refresh(){this.isEnabled=this._stack.length>0}get createdBatches(){return this._createdBatches}addBatch(t){const e=this.editor.model.document.selection,s={ranges:e.hasOwnRange?Array.from(e.getRanges()):[],isBackward:e.isBackward};this._stack.push({batch:t,selection:s}),this.refresh()}clearStack(){this._stack=[],this.refresh()}_restoreSelection(t,e,s){const o=this.editor.model,i=o.document,a=[],d=t.map((t=>t.getTransformedByOperations(s))),c=d.flat();for(const t of d){const e=t.filter((t=>t.root!=i.graveyard)).filter((t=>!r(t,c)));e.length&&(n(e),a.push(e[0]))}a.length&&o.change((t=>{t.setSelection(a,{backward:e})}))}_undo(t,e){const i=this.editor.model,a=i.document;this._createdBatches.add(e);const n=t.operations.slice().filter((t=>t.isDocumentOperation));n.reverse();for(const t of n){const n=t.baseVersion+1,r=Array.from(a.history.getOperations(n)),d=s([t.getReversed()],r,{useRelations:!0,document:this.editor.model.document,padWithNoOps:!1,forceWeakRemove:!0}).operationsA;for(let s of d){const n=s.affectedSelectable;n&&!i.canEditAt(n)&&(s=new o(s.baseVersion)),e.addOperation(s),i.applyOperation(s),a.history.setOperationAsUndone(t,s)}}}}function n(t){t.sort(((t,e)=>t.start.isBefore(e.start)?-1:1));for(let e=1;e<t.length;e++){const s=t[e-1].getJoined(t[e],!0);s&&(e--,t.splice(e,2,s))}}function r(t,e){return e.some((e=>e!==t&&e.containsRange(t,!0)))}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class d extends a{execute(t=null){const e=t?this._stack.findIndex((e=>e.batch==t)):this._stack.length-1,s=this._stack.splice(e,1)[0],o=this.editor.model.createBatch({isUndo:!0});this.editor.model.enqueueChange(o,(()=>{this._undo(s.batch,o);const t=this.editor.model.document.history.getOperations(s.batch.baseVersion);this._restoreSelection(s.selection.ranges,s.selection.isBackward,t)})),this.fire("revert",s.batch,o),this.refresh()}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class c extends a{execute(){const t=this._stack.pop(),e=this.editor.model.createBatch({isUndo:!0});this.editor.model.enqueueChange(e,(()=>{const s=t.batch.operations[t.batch.operations.length-1].baseVersion+1,o=this.editor.model.document.history.getOperations(s);this._restoreSelection(t.selection.ranges,t.selection.isBackward,o),this._undo(t.batch,e)})),this.refresh()}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class h extends e{constructor(){super(...arguments),this._batchRegistry=new WeakSet}static get pluginName(){return"UndoEditing"}init(){const t=this.editor;this._undoCommand=new d(t),this._redoCommand=new c(t),t.commands.add("undo",this._undoCommand),t.commands.add("redo",this._redoCommand),this.listenTo(t.model,"applyOperation",((t,e)=>{const s=e[0];if(!s.isDocumentOperation)return;const o=s.batch,i=this._redoCommand.createdBatches.has(o),a=this._undoCommand.createdBatches.has(o);this._batchRegistry.has(o)||(this._batchRegistry.add(o),o.isUndoable&&(i?this._undoCommand.addBatch(o):a||(this._undoCommand.addBatch(o),this._redoCommand.clearStack())))}),{priority:"highest"}),this.listenTo(this._undoCommand,"revert",((t,e,s)=>{this._redoCommand.addBatch(s)})),t.keystrokes.set("CTRL+Z","undo"),t.keystrokes.set("CTRL+Y","redo"),t.keystrokes.set("CTRL+SHIFT+Z","redo")}}var l='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m5.042 9.367 2.189 1.837a.75.75 0 0 1-.965 1.149l-3.788-3.18a.747.747 0 0 1-.21-.284.75.75 0 0 1 .17-.945L6.23 4.762a.75.75 0 1 1 .964 1.15L4.863 7.866h8.917A.75.75 0 0 1 14 7.9a4 4 0 1 1-1.477 7.718l.344-1.489a2.5 2.5 0 1 0 1.094-4.73l.008-.032H5.042z"/></svg>',m='<svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="m14.958 9.367-2.189 1.837a.75.75 0 0 0 .965 1.149l3.788-3.18a.747.747 0 0 0 .21-.284.75.75 0 0 0-.17-.945L13.77 4.762a.75.75 0 1 0-.964 1.15l2.331 1.955H6.22A.75.75 0 0 0 6 7.9a4 4 0 1 0 1.477 7.718l-.344-1.489A2.5 2.5 0 1 1 6.039 9.4l-.008-.032h8.927z"/></svg>';
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */
class u extends e{static get pluginName(){return"UndoUI"}init(){const t=this.editor,e=t.locale,s=t.t,o="ltr"==e.uiLanguageDirection?l:m,i="ltr"==e.uiLanguageDirection?m:l;this._addButton("undo",s("Undo"),"CTRL+Z",o),this._addButton("redo",s("Redo"),"CTRL+Y",i)}_addButton(t,e,s,o){const a=this.editor;a.ui.componentFactory.add(t,(n=>{const r=a.commands.get(t),d=new i(n);return d.set({label:e,icon:o,keystroke:s,tooltip:!0}),d.bind("isEnabled").to(r,"isEnabled"),this.listenTo(d,"execute",(()=>{a.execute(t),a.editing.view.focus()})),d}))}}
/**
 * @license Copyright (c) 2003-2023, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */class g extends e{static get requires(){return[h,u]}static get pluginName(){return"Undo"}}export{g as Undo,h as UndoEditing,u as UndoUI};